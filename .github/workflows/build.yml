name: CI

on:
  push:
    branches:
    - main
  pull_request:

# Explicit permissions following security best practices (principle of least privilege)
permissions:
  contents: read
  pull-requests: read
  checks: write

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # Prevent stuck jobs

    services:
      postgresql:
        image: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        env:
          POSTGRES_DB: thredded_gem_test
          POSTGRES_USER: thredded
          POSTGRES_PASSWORD: thredded

      mysql2:
        image: mysql:8.0
        env:
          MYSQL_ROOT_HOST: "%"
          MYSQL_DATABASE: thredded_gem_test
          MYSQL_USER: thredded
          MYSQL_PASSWORD: thredded
          MYSQL_ROOT_PASSWORD: thredded
        options: >-
          --health-cmd "mysqladmin ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 3
        ports:
          - "3306:3306"

    strategy:
      fail-fast: false
      matrix:
        node: ["22"]
        rails_version: ["7.0", "7.1", "7.2", "8.0"]
        db: [sqlite3, postgresql, mysql2]
        include:
          # one ruby per rails - to cut down noise, we can add variety if there's a reason
          - rails_version: 7.0
            ruby: 3.1
          - rails_version: 7.1
            ruby: 3.2
          - rails_version: 7.2
            ruby: 3.2
          - rails_version: 8.0
            ruby: 3.4

    env:
      RAILS_ENV: test
      COVERAGE: 1
      FERRUM_DEFAULT_TIMEOUT: 20
      BUNDLE_GEMFILE: "${{ github.workspace }}/spec/gemfiles/rails_${{ matrix.rails_version }}.gemfile"
      DB: ${{ matrix.db }}
      DB_HOST: 127.0.0.1
      DB_POOL: 5
      DB_USERNAME: thredded
      DB_PASSWORD: thredded
      NODE_OPTIONS: --openssl-legacy-provider

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: ${{ matrix.ruby }}
        bundler-cache: true # install gems and cache

    - name: Set up Chrome
      uses: browser-actions/setup-chrome@v2

    - name: Set up Node.js
      uses: actions/setup-node@v6
      with:
        node-version: ${{ matrix.node }}

    - name: Restore Yarn cache
      uses: actions/cache/restore@v4
      id: restore-yarn-cache
      with:
        path: |
          spec/dummy/node_modules
        key: yarn-${{ runner.os }}-${{ hashFiles('spec/dummy/yarn.lock') }}
        restore-keys: |
          yarn-${{ runner.os }}-

    - name: Install Node Packages via Yarn
      working-directory: spec/dummy
      run: yarn install --frozen-lockfile

    - name: Save Yarn cache
      uses: actions/cache/save@v4
      if: steps.restore-yarn-cache.outputs.cache-hit != 'true'
      with:
        path: |
          spec/dummy/node_modules
        key: yarn-${{ runner.os }}-${{ hashFiles('spec/dummy/yarn.lock') }}

    - name: Restore Onebox Data and Views Cache
      uses: actions/cache/restore@v4
      id: restore-onebox-data-and-views
      with:
        path: |
          tmp/cache/onebox-data
          tmp/cache/onebox-views
          spec/dummy/tmp/cache/onebox-data
          spec/dummy/tmp/cache/onebox-views
        key: onebox-data-and-views-${{ runner.os }}-${{ github.sha }}
        restore-keys: |
          onebox-data-and-views-${{ runner.os }}-

    - name: Restore compiled assets cache
      uses: actions/cache/restore@v4
      id: restore-assets-cache
      if: matrix.db == 'sqlite3'
      with:
        path: |
          spec/dummy/public/assets
          spec/dummy/tmp/cache/assets
        key: assets-${{ matrix.rails_version }}-${{ hashFiles('spec/dummy/app/assets/**/*', 'spec/dummy/app/javascript/**/*') }}
        restore-keys: |
          assets-${{ matrix.rails_version }}-

    - name: "Check that assets:precompile works (sqlite3 only)"
      if: matrix.db == 'sqlite3' && steps.restore-assets-cache.outputs.cache-hit != 'true'
      working-directory: spec/dummy
      run: |
        export PRECOMPILE_ASSETS=1
        bundle exec rails assets:precompile

    - name: Save compiled assets cache
      uses: actions/cache/save@v4
      if: matrix.db == 'sqlite3' && steps.restore-assets-cache.outputs.cache-hit != 'true'
      with:
        path: |
          spec/dummy/public/assets
          spec/dummy/tmp/cache/assets
        key: assets-${{ matrix.rails_version }}-${{ hashFiles('spec/dummy/app/assets/**/*', 'spec/dummy/app/javascript/**/*') }}

    - name: "Run Tests: test:nojs"
      run: |
        SIMPLECOV_NAME="test:nojs" bundle exec rspec --force-color --format d --tag=~js --tag=~i18n_tasks

    - name: "Run Tests: test:js"
      run: |
        SIMPLECOV_NAME="test:js" bundle exec rspec --force-color --format d --tag=js

    - name: "Run Tests: spec/migrations"
      run: |
        MIGRATION_SPEC=1 SIMPLECOV_NAME="test:migrations" bundle exec rspec spec/migration --force-color --format d

    - name: "Run Tests: spec/configuration/run_all"
      run: |
        spec/configuration/run_all

    - name: "Run Tests: run_spec_repeatedly"
      run: |
        bin/run_specs_repeatedly --tag=threaded_render

    - name: Upload capybara screenshots as artifacts after failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: capybara-rails${{ matrix.rails_version }}-ruby${{ matrix.ruby }}-${{ matrix.db }}
        path: spec/dummy/tmp/capybara/
        retention-days: 7
        if-no-files-found: ignore

    # - name: Test & publish code coverage
    #   uses: paambaati/codeclimate-action@v8.0.0
    #   env:
    #     CC_TEST_REPORTER_ID: <code_climate_reporter_id>

    - name: Cache Onebox Data and Views Cache
      uses: actions/cache/save@v4
      if: steps.restore-onebox-data-and-views.outputs.cache-hit != 'true'
      with:
        path: |
          tmp/cache/onebox-data
          tmp/cache/onebox-views
          spec/dummy/tmp/cache/onebox-data
          spec/dummy/tmp/cache/onebox-views
        key: onebox-data-and-views-${{ runner.os }}-${{ github.sha }}

  rubocop:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    env:
      BUNDLE_GEMFILE: spec/gemfiles/rubocop.gemfile

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: 3.4
        bundler-cache: true

    - name: Rubocop
      run: |
        bundle exec rubocop

  i18n-tasks:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    env:
      BUNDLE_GEMFILE: spec/gemfiles/i18n-tasks.gemfile

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: 3.4
        bundler-cache: true

    - name: i18n health
      run: |
        bundle exec i18n-tasks health
